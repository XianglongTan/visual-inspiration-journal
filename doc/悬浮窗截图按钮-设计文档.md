# DesignLog 悬浮窗截图按钮 - 设计文档

## 1. 功能概述

在浏览器扩展中提供**全局悬浮窗按钮**，使用户在任何网页都能快速截屏，并将截图**直接写入当天的 log**，同时由 AI 自动识别并生成设计相关**关键词（标签）**。悬浮窗贴附在浏览器窗口右侧，支持**隐藏**（仅保留一条边 + 还原小按钮）与**还原**（点击还原按钮恢复完整按钮）。

**截屏范围**：不限于当前浏览器标签页，而是**屏幕中任意区域**——可包含其他应用窗口、桌面、其他显示器、或当前页面的一部分，与微信桌面版截屏一致。

### 目标用户与场景

- 设计师、创意工作者在浏览 Dribbble、Behance、桌面上的 Figma/Sketch、或其他任意界面时，看到灵感即可框选**屏幕任意区域**截取并落入当日手账，无需先保存图片再打开手账上传。
- 悬浮窗不遮挡主要内容，不需要时可收起为右侧细边，减少干扰。

---

## 2. 悬浮窗按钮

### 2.1 展示范围

- **所有页面**：通过 Content Script 在 `<all_urls>` 注入，用户访问任意网页时都会看到该悬浮窗（在扩展已安装且启用的前提下）。
- **不注入的页面**：`chrome://`、`edge://`、Chrome Web Store、浏览器新标签页等受限页面无法注入 Content Script，这些页面不显示悬浮窗。

### 2.2 位置与层级

- **位置**：贴在**浏览器窗口右侧**（如 `right: 0`），垂直居中（如 `top: 50%; transform: translateY(-50%)`）。使用 `position: fixed` 相对视口定位。
- **层级**：使用较高的 `z-index`，保证悬浮在页面内容之上，但不覆盖浏览器原生 UI（如地址栏）。与截图遮罩层区分：按钮层 < 遮罩层。
- **缩放**：悬浮窗**不随页面 zoom 缩放**，始终保持约 72px / 12px 的视觉尺寸（实现时可通过独立层或 transform 等方式与页面 zoom 隔离）。

### 2.3 两种状态

| 状态     | 描述 |
|----------|------|
| **展开** | 完整悬浮窗：显示「截图」主按钮（含图标与文案）、以及「收起」小按钮（如左侧箭头）。宽度约 72px，便于点击。 |
| **隐藏** | 仅保留**一条竖边**（约 12px 宽）和**还原小按钮**（如右箭头）。收起后不占空间，仅留一条边提示可展开。 |

### 2.4 交互

- **隐藏**：用户点击「收起」小按钮 → 悬浮窗变为「隐藏」状态（一条边 + 还原按钮）。
- **还原**：用户点击「还原」小按钮（或点击该细边区域）→ 悬浮窗恢复「展开」状态，显示完整截图按钮。
- **截图**：在展开状态下，点击主「截图」按钮 → 进入区域框选模式（见下文）。**全局单例**：同一时间只允许一次截图流程在进行；若其他标签页点击截图，可提示「请先完成当前截图」或忽略，由实现决定。

### 2.5 视觉与可访问性

- 悬浮窗样式需与 DesignLog 品牌一致（如玫瑰/粉色系），与主应用风格统一。
- **悬浮窗整体透明度设置为 70%**（即 `opacity: 0.7` 或等价的 rgba/HSLA），避免完全遮挡背后页面内容。
- 提供 `title` / `aria-label`，便于键盘与读屏用户理解「收起」「展开」「截屏并导入今日手账」。

---

## 3. 截图与写入当日 Log 流程

### 3.1 区域选择

- 点击「截图」后，**默认使用屏幕捕获**（整屏），**完全不弹窗**，扩展侧直接按「整个屏幕」发起捕获，不出现系统级源选择对话框。直接出现**全屏半透明遮罩**（遮罩覆盖整个屏幕），提示「拖拽框选区域，松开即截屏 · 按 Esc 取消」。
- 用户**拖拽**框选**屏幕上的任意矩形区域**，**松开鼠标**即确认；框选过小（如宽或高 < 10px）则视为取消。
- **Esc** 键可随时取消并关闭遮罩。

### 3.2 截屏与数据处理（像素截屏，屏幕任意区域）

采用**像素截屏**方式，与微信桌面版截屏一致：截取的是**屏幕中任意区域**的像素，不限于当前标签页，不解析 DOM/CSS，所见即所得。可截到其他应用、桌面、其他窗口、多显示器等，并避免 oklch、跨域图、复杂样式等 DOM 截屏带来的问题。

#### 捕获能力要求

- 要实现「屏幕任意区域」，须使用**桌面/屏幕捕获 API**，例如：
  - Chrome 扩展：**`chrome.desktopCapture`**（在 Background 中请求桌面源，获得 streamId，再在页面或 offscreen 中取流）；
  - 或页面内 **`getDisplayMedia()`**（请求时**默认指定屏幕捕获**，不弹出源选择或默认选「整个屏幕」）。
- **默认屏幕捕获**：**完全不弹窗**，不出现系统源选择器；扩展侧直接按「整个屏幕」发起捕获。流程概览：默认获取整屏流/帧 → 展示覆盖**整个屏幕**的框选遮罩 → 用户拖拽框选区域 → 从流/帧中截取对应区域得到 PNG，转为 Data URL。

#### 流程要点

- **Content Script / 扩展页**：展示覆盖**整个屏幕**的框选遮罩，收集用户拖拽得到的**选区矩形**（left、top、width、height）。**选区坐标相对整屏**（与捕获画面/整屏坐标系一致）。将选区坐标及必要的捕获上下文（如 streamId 或当前帧）通过消息传给 Background 或在本页完成裁剪。
- **Background / 扩展页**：若在 Background 中拿到的是 streamId，需在具备媒体能力的上下文（如扩展页、offscreen document）中取得实际画面帧，再按用户选区**裁剪**出区域，得到 PNG 并转为 Data URL。将 Data URL 写入 `chrome.storage.local.pendingScreenshot`，然后**打开或聚焦**手账页：若已有扩展手账页标签则聚焦该标签，否则新开标签打开 `index.html`。
- **坐标与缩放**：选区坐标与捕获源分辨率、设备像素比、多显示器偏移需统一换算，保证框选区域与最终裁剪区域一致。

#### 输出与后续

- 最终得到 **Data URL**（如 `data:image/png;base64,...`），供 3.3、3.4 的存储与手账页消费，与现有逻辑一致。

### 3.3 扩展内传递

- **Content Script / 扩展页 → Background**：发送消息，类型如 `CAPTURE_REGION`，携带用户框选的**选区坐标**（如 `rect: { left, top, width, height }`）及与捕获源相关的上下文（如 streamId，若采用 desktopCapture）。或在本页从 MediaStream 取帧并裁剪后直接传 Data URL。
- **Background**：若采用桌面捕获，需在具备媒体能力的上下文中从捕获源取帧，按 `rect` 裁剪后转为 Data URL，写入 `chrome.storage.local.pendingScreenshot`，然后**打开或聚焦**扩展的手账页面（如 `chrome.runtime.getURL('index.html')`）。

### 3.4 手账页消费与写入「当天」Log

- 手账页（SPA）加载后，在合适的生命周期（如 `useEffect` 且数据已从 IndexedDB 加载完成）中读取 `chrome.storage.local` 的 `pendingScreenshot`。
- 若存在待导入截图：
  1. **确定「当天」**：按**用户本地日期**（处理 pendingScreenshot 时的本地日期）计算所属周（如周一为起点的周 ID）以及「今天」在周视图中的列索引（周一～周五 + 周末）。
  2. **写入当日 log**：在对应周的 `days[dayIndex]` 中追加一张新卡片（`ImageCard`）。`id`、`rotation`、`decorationType`、`decorationColor` 等**默认值与主应用新建 ImageCard 的规则一致**；包含 `url`（即 dataUrl）、`terms: []`、`createdAt`、`isLoading: true`。
  3. **触发关键词识别**：调用现有 AI 服务（如 `generateDesignTerms(dataUrl)`），得到设计术语列表后，更新该卡片的 `terms` 并设 `isLoading: false`。
  4. **清理**：从 `chrome.storage.local` 中移除 `pendingScreenshot`，避免下次打开重复导入。
  5. **视图**：可将 `currentDate` 切到「本周」或「今天」，使用户立即看到新卡片。

### 3.5 数据模型（与现有一致）

- 单张卡片：`ImageCard`（`id`, `url`, `terms`, `createdAt`, `rotation`, `decorationType`, `decorationColor`, `isLoading`）。新建截图卡片时，`id` 生成规则及 `rotation`、`decorationType`、`decorationColor` 的默认值与主应用一致。
- 周数据：`WeekData`（`id`, `days: { 0..5 }`, `notes`, `notesHeight`）。
- 持久化：与主应用一致，使用 IndexedDB（如 `designlog_v1_data`），无需额外存储方案。

---

## 4. 关键词识别

- 使用项目已有的 **AI 设计术语生成服务**，对截图 Base64 调用接口，返回 5～10 个设计相关标签（如 "Glassmorphism", "Brutalism"）。
- 写入 log 时先以 `terms: []`、`isLoading: true` 展示卡片，请求返回后更新 `terms` 并置 `isLoading: false`，与主应用内「上传图片后自动打标签」逻辑一致。

---

## 5. 技术实现要点（与现有代码对应）

| 模块 | 文件/位置 | 职责 |
|------|------------|------|
| Content Script | `content/screenshot.ts` | 注入悬浮窗 DOM、样式，实现展开/隐藏；截屏时配合桌面/屏幕捕获流程（如发起捕获、展示框选遮罩），收集**屏幕任意区域**的选区坐标，发送 `CAPTURE_REGION`（带 rect 及捕获上下文），不进行 DOM 截屏 |
| Background | `public/background.js` | 参与桌面捕获（如 `chrome.desktopCapture` 获取 streamId）或接收裁剪结果；从捕获源取帧、按 rect 裁剪后转为 Data URL，写入 `chrome.storage.local.pendingScreenshot`，打开 index.html |
| 手账 SPA | `App.tsx` | 启动后读取 `pendingScreenshot`，调用 `addScreenshotToToday`：写入当日 `days[dayIndex]`，调用 `generateDesignTerms` 更新 `terms` |
| 构建 | `vite.content.config.ts` | 将 `content/screenshot.ts` 打包为 `content.js`，由 manifest 的 content_scripts 注入 |

说明：截屏采用像素截屏（屏幕任意区域），不再使用 html2canvas 或 `stripUnsupportedColors`。要实现屏幕/任意窗口截取，需使用**桌面捕获**能力，而非仅当前标签页截图。

### Manifest 要求

- `content_scripts`: `matches: ["<all_urls>"]`，`run_at: "document_idle"`。
- **`permissions`**：需包含 **桌面捕获** 相关权限（如 Chrome 的 `desktopCapture` 或与 `getDisplayMedia` 所需的策略），以便截取屏幕或指定窗口的任意区域。
- 其余：storage、扩展页；若在手账页内调用 AI API，需相应 `host_permissions`。

---

## 6. 非功能需求

- **性能**：像素截屏由桌面捕获 API 取流/帧后裁剪，若从选择捕获源到拿到结果有延迟，可在遮罩上显示「截屏中…」提示。
- **错误**：桌面捕获取流/取帧或裁剪失败、AI API 失败时，应有日志或轻量提示，避免静默失败；可 `sendResponse({ ok: false })` 通知调用方。
- **隐私**：截图仅存于用户本地（IndexedDB + 临时 storage.local），不上传到除 AI 标注服务以外的服务器；AI 调用需符合项目现有配置与隐私策略。

---

## 7. 文档变更记录

| 日期 | 说明 |
|------|------|
| 2025-02-17 | 初版：悬浮窗按钮范围、隐藏/还原、截图流程、写入当日 log、关键词识别及与现有实现的对应关系。 |
| 2025-02-17 | 补充：悬浮窗透明度 70%；截屏时 oklch 等不支持颜色函数的解析问题说明及处理方式。 |
| 2025-02-17 | 补充：微信截屏为像素截屏、本扩展为 DOM 截屏的对比说明；可选方案 `captureVisibleTab` 简述。 |
| 2025-02-17 | **方案变更**：不再使用 DOM 截屏，统一采用微信式像素截屏（`captureVisibleTab` + 按选区裁剪）；更新 3.2、3.3、第 5 节及 Manifest 要求。 |
| 2025-02-17 | 截屏范围明确为**屏幕中任意区域**（不限于当前标签页）；实现需依赖桌面/屏幕捕获 API（如 `desktopCapture` / `getDisplayMedia`），更新 1、3.1、3.2、3.3、5、6。 |
| 2025-02-17 | 区域选择**默认屏幕捕获**，不需要用户选择捕获源；更新 3.1、3.2 捕获能力与流程概览。 |
| 2025-02-18 | 明确：截屏**完全不弹窗**直接整屏；遮罩为整屏、坐标相对整屏；受限页面不注入；当天为用户本地日期；手账页打开/聚焦规则；悬浮窗不随 zoom 缩放；截图流程全局单例；ImageCard 默认值与 id 与主应用一致。 |
